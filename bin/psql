#!/bin/bash
set -e

command -v which >/dev/null 2>&1 || { echo "I require which but it's not installed.  Aborting." >&2; exit 1; }

for p in `which -a psql`;do
    [ "`realpath "$p"`" != "`realpath "$0"`" ] && psql="$p" && break
done

[ "$p" == "" ]  && echo "$0: ERROR: no psql on PATH?" && exit 1

echo    "psql: $psql" >&2

for arg in "$@";do 
    [ "$arg" != "-X" ] && ARGS+=( "$arg" )
done

[ "$PSQLRC" == "" ] && PSQLRC=~/.psqlrc

PSQLRC=<(
[ -e "$PSQLRC" ] && echo "\i $PSQLRC"
e='$e'
cat << EOF
-- save pid into file
\o /tmp/_pgsql_debug_pid
select pg_backend_pid();
\! sed -r 's/ +//g;/^[0-9]+$/p;d' -i /tmp/_pgsql_debug_pid
\o
do $e$ begin raise notice 'backend PID stored in /tmp/_pgsql_debug_pid'; end $e$ ;
EOF
if [ "$PSQL_WAIT_PORT" != "" ];then
cat << EOF
-- wait for debugger
do $e$ begin raise notice 'waiting for debugger; connect to 5555 after attach'; end $e$ ;
\! cat /tmp/_pgsql_debug_pid | nc -l -w0 -p 5555
\! sleep 3
EOF
fi
) exec $psql "$@"
